let adInfo=null;const onLoaded=new CustomEvent("ad-on-loaded"),onFailed=new CustomEvent("ad-on-failed"),onImpression=new CustomEvent("ad-impression"),getAd=(e,n)=>{new Promise((e,n)=>{fetch("http://localhost:3000/ads").then(e=>e.json()).then(n=>{window.dispatchEvent(onLoaded),adInfo=n,e(!0)}).catch(e=>{window.dispatchEvent(onFailed);(e=>{fetch("http://localhost:3000/log",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({error:e.toString(),time:new Date})}).then(e=>e.json()).then(e=>console.log(e)).catch(e=>console.log(e))})(e.toString()),n(!1)})}).then(()=>renderAd(e,n)).catch(e=>console.log(e))},renderAd=(e,n)=>{let t=!1;const o=document.querySelector(e);if(!o)return void console.log("未找到可放置廣告的 element");const{url:i,type:s,image:l,title:r,success:d,video_url:a,description:c,impression_url:h}=adInfo;if(!d){const e='<div class="no-ad">目前沒有任何廣告</div>';return void(o.innerHTML=e)}if(n!==s&&"ALL"!==n){const e=`<div class="no-ad">目前沒有符合 ${n} 類型的廣告</div>`;return void(o.innerHTML=e)}if("BANNER"===s){const e=`\n        <a class="link" href="${i}" target="_blank" title="${c}">\n          <div class="banner" style="background-image: url(${l})"></div>\n          <div class="content">\n            <i class="info-icon">i</i>\n            <h2 class="domain">${(e=>{return e.match(/(\:\/\/)([a-z]|[0-9]|\.|\-)+/g)[0].replace("://","").toUpperCase()})(i)}</h2>\n            <h1 class="title">${r}</h1>\n          </div>\n        </a>\n      `;o.innerHTML=e}else if("VIDEO"===s){const e=`\n        <iframe class="video" src="${a}" alt="${r}" allowFullScreen></iframe>\n      `;o.innerHTML=e}const g=()=>{if(t)return;const e=e=>{const n=e.getBoundingClientRect(),t=n.width*n.height;return(e=>e.left<0?e.right:e.left+e.width>window.innerWidth?window.innerWidth-e.left:e.width)(n)*(e=>e.top<0?e.bottom:e.top+e.height>window.innerHeight?window.innerHeight-e.top:e.height)(n)/t};e(o)>.5&&(t=!0,setTimeout(()=>{if(e(o)>.5){o.dispatchEvent(onImpression),(()=>{const e=JSON.parse(localStorage.getItem("memorizedUrl"))||[];if(Array.isArray(e)&&e.length||(console.log(`觸發呼叫 impression_url: ${h}`),localStorage.setItem("memorizedUrl",JSON.stringify([h]))),e.length){e.filter(e=>h===e).length?console.log(`${h} 已經呼叫過 1 次`):(console.log(`觸發呼叫 impression_url: ${h}`),localStorage.setItem("memorizedUrl",JSON.stringify([...e,h])))}})(),o.classList.add("impression")}else t=!1},1e3))};g(),window.addEventListener("scroll",g)};